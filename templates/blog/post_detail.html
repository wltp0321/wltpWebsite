{% extends "base.html" %}
{% load widget_tweaks %}
{% block title %}{{ post.title }} - 블로그{% endblock %}

{% block content %}
<section class="py-12 bg-gray-50 border-b border-gray-200">
<div class="max-w-4xl mx-auto flex justify-start">
  <a href="{% url 'blog:post_list' %}" 
     class="inline-block px-4 py-2 mb-4 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
    ← 글 목록으로 돌아가기
  </a>
</div>


    <div class="max-w-4xl mx-auto px-4 flex items-center justify-between">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">{{ post.title }}</h1>

        {% if user.is_authenticated and user == post.author or user.is_staff %}
            <a href="{% url 'blog:post_edit' post.pk %}" 
               class="inline-block px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">
               글 수정
            </a>
            <a href="{% url 'blog:post_delete' post.pk %}"
            class="inline-block px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 ml-2">
            글 삭제
            </a>
        {% endif %}
    </div>
    <div class="max-w-4xl mx-auto px-4 flex items-center text-sm text-gray-500 space-x-4">
        <span>작성자: {{ post.author }}</span>
        <span>작성일: {{ post.created_at|date:"Y-m-d H:i" }}</span>
        <span>수정일: {{ post.updated_at|date:"Y-m-d H:i" }}</span>
    </div>
</section>

<section class="max-w-4xl mx-auto p-8 bg-white rounded-xl shadow mt-10">
    <article class="prose prose-lg max-w-none" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji';">
        {{ formatted_markdown|safe }}
    </article>
</section>

<section class="max-w-4xl mx-auto px-4 py-6">
    {% if user.is_authenticated %}
        <button id="like-button" data-post-id="{{ post.pk }}"
                class="inline-flex items-center px-4 py-2 rounded-lg
                       {% if user in post.likes.all %}
                           bg-red-500 text-white hover:bg-red-600
                       {% else %}
                           bg-gray-200 text-gray-700 hover:bg-gray-300
                       {% endif %}
                       transition"
        >
            ❤️ 좋아요
            <span id="like-count" class="ml-2 font-semibold">{{ post.total_likes }}</span>
        </button>
    {% else %}
        <p class="text-gray-500">좋아요는 로그인 후 가능합니다.</p>
    {% endif %}
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const likeBtn = document.getElementById('like-button');
    if (!likeBtn) return;

    likeBtn.addEventListener('click', function () {
        const postId = this.dataset.postId;
        const csrftoken = getCookie('csrftoken');

        fetch(`/blog/post/${postId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('오류가 발생했습니다.');
                return;
            }
            // 버튼 스타일과 좋아요 숫자 업데이트
            const likeCount = document.getElementById('like-count');
            likeCount.textContent = data.total_likes;
            if (data.liked) {
                likeBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                likeBtn.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
            } else {
                likeBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                likeBtn.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
            }
        })
        .catch(() => alert('네트워크 오류가 발생했습니다.'));
    });

    // CSRF 토큰 가져오기 함수 (Django docs 참고)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i=0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // 해당 이름의 쿠키 찾기
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>




<section class="py-12 bg-gray-50 border-t border-gray-200">
    <div class="max-w-4xl mx-auto px-4">
        <h2 class="text-xl font-semibold mb-6">댓글</h2>

        {% if comments %}
            {% for comment in comments %}
                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-gray-800">{{ comment.author }}</p>
                        <p class="text-xs text-gray-400 mt-1">
                            작성일: {{ comment.created_at|date:"Y-m-d H:i" }}
                            {% if comment.updated_at and comment.updated_at != comment.created_at %}
                                / 수정일: {{ comment.updated_at|date:"Y-m-d H:i" }}
                            {% endif %}
                        </p>

                    </div>
                    <p class="mt-2 text-gray-700 whitespace-pre-wrap">{{ comment.content }}</p>

                    <div class="mt-3 flex space-x-3 text-sm text-gray-500">
                        {% if user.is_authenticated %}
                            <a href="{% url 'blog:add_reply' post.pk comment.pk %}" class="hover:underline text-blue-600">대댓글</a>
                        {% endif %}
                        {% if user.is_authenticated and user == comment.author or user.is_staff %}
                            <a href="{% url 'blog:comment_edit' comment.pk %}" class="hover:underline text-green-600">수정</a>
                            <a href="{% url 'blog:comment_delete' comment.pk %}" class="hover:underline text-red-600">삭제</a>
                        {% endif %}
                    </div>

                    <!-- 대댓글 -->
                    {% for reply in comment.replies.all %}
                        <div class="ml-6 mt-4 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-300">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold text-gray-700">{{ reply.author }}</p>
                                <p class="text-xs text-gray-400 mt-1">
                                    작성일: {{ comment.created_at|date:"Y-m-d H:i" }}
                                    {% if comment.updated_at and comment.updated_at != comment.created_at %}
                                        / 수정일: {{ comment.updated_at|date:"Y-m-d H:i" }}
                                    {% endif %}
                                </p>

                            </div>
                            <p class="mt-1 text-gray-600 whitespace-pre-wrap">{{ reply.content }}</p>

                            <div class="mt-2 flex space-x-3 text-xs text-gray-500">
                                {% if user.is_authenticated and user == reply.author or user.is_staff %}
                                    <a href="{% url 'blog:comment_edit' reply.pk %}" class="hover:underline text-green-600">수정</a>
                                    <a href="{% url 'blog:comment_delete' reply.pk %}" class="hover:underline text-red-600">삭제</a>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        {% else %}
            <p class="text-gray-500 italic">아직 댓글이 없습니다.</p>
        {% endif %}

        <!-- 댓글 작성 폼 -->
        {% if user.is_authenticated %}
            <form method="post" action="{% url 'blog:add_comment' post.pk %}" class="mt-6">
                {% csrf_token %}
                {{ form.content|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" }}
                <button type="submit" class="mt-3 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    댓글 작성
                </button>
            </form>
        {% else %}
            <p class="text-gray-500 mt-6">댓글 작성은 로그인 후 가능합니다.</p>
        {% endif %}
    </div>
</section>


<!-- 좋아요, 댓글 등... 아래 생략 가능 -->

<style>
.prose h1 {
    font-size: 2.5rem !important;
    margin-bottom: 1rem !important;
}
.prose h2 {
    font-size: 2rem !important;
    margin-bottom: 1rem !important;
}
.prose h3 {
    font-size: 1.5rem !important;
    margin-bottom: 1rem !important;
}
.prose pre {
    background-color: #f3f4f6;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
}
.prose code {
    background-color: #e5e7eb;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-family: monospace;
}
.prose a {
    color: #2563eb;
    text-decoration: underline;
    transition: color 0.2s ease-in-out;
}
.prose a:hover {
    color: #1e40af;
}
.prose table {
    width: 100%;
    border-collapse: collapse;
    margin: 1em 0;
}
.prose th, .prose td {
    border: 1px solid #d0d7de;
    padding: 0.5em 1em;
    text-align: left;
}
.prose th {
    background-color: #f6f8fa;
    font-weight: 600;
}
.prose tr:nth-child(even) {
    background-color: #fafbfc;
}
.prose blockquote {
    font-style: normal;
    color: #374151;
    border-left: 4px solid #d1d5db;
    padding: 0.75rem 1rem;
    margin: 1rem 0;
    background-color: #eff6ff;
    border-radius: 0.375rem;
}
</style>
{% endblock %}
